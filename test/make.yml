---
dependencies:
  - role: rails-server

defaults: 
  portal_login_name: "portal-login"
  portal_login_domain: "danak.dk"
  portal_login_git: "git@rbprod:./portal-login.git"
  portal_login_user: "portal_login"
  portal_login_group: "portal_login"
  portal_login_path: "/var/www/portal-login"

vars:
  portal_host: "{{ portal_login_name}}.{{ portal_login_domain }}"

tasks:
  - name: "Ensure MsSQL libraries"
    import_tasks: "tasks/mssql.yml"

  - name: "Find required ruby version"
    shell: "git archive --remote={{ portal_login_git }} HEAD .ruby-version | tar x -O"
    register: find_ruby_version
    delegate_to: localhost
    failed_when: find_ruby_version.rc != 0
    changed_when: false

  - name: "Ensure rails user"
    import_tasks: "tasks/rails_user.yml"
    vars:
      username: "{{ portal_login_user }}"
      ruby_version: "{{ find_ruby_version.stdout }}"

  - name: "Ensure rails application"
    import_tasks: "tasks/rails_appl.yml"
    vars:
      appl_name: "{{ portal_login_name }}"
      appl_git: "{{ portal_login_git }}"
      appl_user: "{{ portal_login_user }}"
      appl_group: "{{ portal_login_group }}"
      appl_path: "{{ portal_login_path }}"

  - name: "Ensure postgres user"
    import_tasks: "tasks/rails_postgres.yml"
    vars:
      appl_name: "{{ portal_login_name }}"
      appl_user: "{{ portal_login_user }}"
      appl_path: "{{ portal_login_path }}"

  - name: "Ensure virtual host definition"
    import_tasks: "tasks/rails_vhost.yml"
    vars:
      appl_host: "{{ portal_login_name}}.{{ portal_login_domain }}"
      appl_name: "{{ portal_login_name }}"
      appl_user: "{{ portal_login_user }}"
      appl_path: "{{ portal_login_path }}"
      template: "rails"

  - name: "Terminate with instructions for the operator"
    debug:
      msg: [ 'TODO: Please create .env.production' ]


